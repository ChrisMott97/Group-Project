<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SH Monitoring System | Sensor not found</title>
        <link href="css/stylesheet.css" rel='stylesheet' type='text/css'/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="js/js.js" charset="UTF-8"></script>
        <link rel="icon" type="image" href="/images/favicon.png">
        <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    </head>
    <body>
        <div class="navbar-div">
            <img src="images/uoe.png" class="exeter-logo">
            <a href="/settings" class="profile-link"><p class="profile-name" id="profile-name"><%= user.name %></p><img src=<%= user.picture %> class="profile-pic"></a>
        </div>
        <div class="sidebar-div">
            <div class="sidebar-icon-div">
                <a href="/dash"><span class="sidebar-icon-span">
                    <img src="images/dashboard_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div">
                <a href="/anomalies"><span class="sidebar-icon-span">
                    <img src="images/anomalies_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div">
                <a href="/reports"><span class="sidebar-icon-span">
                    <img src="images/reports_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div sidebar-icon-active">
                <a href="/database"><span class="sidebar-icon-span">
                    <img src="images/database_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div">
                <a href="/code"><span class="sidebar-icon-span">
                    <img src="images/code_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div sidebar-icon-active" id="logout-div">
                <a href="/logout"><span class="sidebar-icon-span">
                    <img src="images/log_out.png" class="sidebar-icon-img">
                </span></a>
            </div>
        </div>
        <div class="main-content-div">
            <h1 class="sensor-title" id="sensor-title"></h1>
            <div class="dashboard-tile-parent">
                <div class="dashboard-tile-div" id="sensor-info">
                    <h1 class="dashboard-title">Sensor Details</h1>
                </div>
                <div class="dashboard-tile-div" id="sensor-location">
                    <h1 class="dashboard-title" id="location-graph-title">Related Sensors</h1>
                    <div id="location-graph"></div>
                </div>
            </div>
            <div class="database-main-content-div" id="anomaly-info-div">
                <h1 class="dashboard-title" id="anomaly-title">Anomaly</h1>
                <p id="anomaly-info-text"></p>
                <div class="comment-table-div">
                    <table>
                        <tbody id="anomaly-comment-table">
                        </tbody>
                    </table>
                </div>
                <h1 class="dashboard-title" id="timeline-title">Anomaly Timeline</h1>
                <div id="anomaly-timeline-div-small"></div>
            </div>
            <div class="dashboard-tile-parent">
                <div class="dashboard-tile-div" id="week-chart-div">
                    <div height="100%"><canvas id="week-chart"></canvas></div>
                </div>
                <div class="dashboard-tile-div" id="day-chart-div">
                    <div height="100%"><canvas id="day-chart"></canvas></div>
                </div>
            </div>
            <div class="dashboard-tile-parent" id="anomaly-timeline-parent">
                <div class="dashboard-tile-div" style="height: auto;">
                    <h1 class="dashboard-title">Detected Anomalies - Previous Week</h1>
                    <div id="anomaly-timeline-div-main"></div>
                </div>
            </div>
            <div class="database-main-content-div" id="sensor-comments-div">
                <h1 class="dashboard-title" id="comment-title">Notes</h1>
                <div class="comment-table-div">
                    <table>
                        <tbody id="comment-table">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="database-main-content-div">
                <h1 class="dashboard-title">Sensor Values</h1>
                <form action="/sensor" method="GET" id="database-search-form">
                    From <input type="date" id="date-from" name="from">
                    to <input type="date" id="date-until" name="until">
                    <!--<select name="ordering"><option value="newest">Newest First</option><option value="oldest">Oldest First</option></select>--><br>
                    <button class="button-styling" id="previous-data-btn" onclick="decrementData()" disabled="disabled"><</button>
                    <input class="button-styling" type="reset">
                    <input class="button-styling" type="submit" value="Search" onsubmit="reloadData()">
                    <button class="button-styling" id="next-data-btn" onclick="incrementData()">></button>
                </form>
                <table class="database-table">
                    <tbody id="sensor-data">
                        <tr class="database-table-row"><th>Date</th><th>Time</th><th>value</th></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="overlay-shadow">
            <a href="javascript:toggleOverlay()"><span id="overlay-span"></span></a>
            <div id="overlay-div">
                <a href="javascript:toggleOverlay()"><img id="overlay-close" src="images/close.png"></a>
                <div id="overlay-content">
                    <div style="text-align: center;">
                        <a href="/logout">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
<script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    let sensorID = urlParams.get('sensorID')

    document.title = 'SH Monitoring System | Sensor #'+sensorID
    document.getElementById('comment-title').innerHTML += ` <a href="javascript:toggleOverlay('comments-form', '', 'Add note to sensor #${sensorID}:')"><img class="add-note-icon" src="images/edit_icon.png"></a>`

    axios.get(`/api/comments?sensor-id=${sensorID}`)
    .then(function (response) {
        let commentsData = response.data

        commentsTable = document.getElementById("comment-table")
        commentsTable.innerHTML = ""

        for (let i = 0; i < commentsData.length; i++ ) {
            axios.get(`/api/users/${commentsData[i].user_id}`)
            .then(function (response) {
                commentAuthor = response.data.name
                commentText = `<tr class="comment-table-row">
                                <td class="comment-table-body">
                                    <span class="comment-author">${commentAuthor}</span><i> ${formatCommentDateString(commentsData[i].created_at)}</i><br>
                                    ${commentsData[i].body}
                                </td></tr>`
                commentsTable.innerHTML += commentText
            })   
        }
        console.log(commentsData.length)
    })

    if (urlParams.has('anomalyID')) {
        const anomalyID = urlParams.get('anomalyID')

        axios.get(`/api/anomalies/${anomalyID}`)
        .then(function (response) {
            detectedAt = formatDateString(response.data.time)
            updatedAt = formatDateString(response.data.updated_at)
            if (response.data.confidence > 0.8) {trafficLight = 'red'}
            else if (response.data.confidence > 0.6) {trafficLight = 'orange'}
            else {trafficLight = 'green'}

            anomalyInfoDiv = document.getElementById("anomaly-info-div")
            anomalyInfoDiv.style.display = "block"
            anomalyText = `An anomaly was detected by this sensor at ${detectedAt[0]}, ${detectedAt[1]} with a
                            confidence of <i style="color: ${trafficLight};">${(response.data.confidence * 100).toFixed(1)}%</i>.`

            if (response.data.status != 1) {
                anomalyText += ` The status of this anomaly was marked
                            as <i>${getStatusString(response.data.status)}</i> by <i>Chris M</i> at ${updatedAt[0]}, ${updatedAt[1]}.`
            } else {
                anomalyText += ` This anomaly has not yet been investigated. Once the anomaly is under investigation, change the status using the edit icon above.`
            }

            document.getElementById("anomaly-info-text").innerHTML += anomalyText+ `<h1 class="dashboard-title" id="anomaly-comments-title">Notes <a href="javascript:toggleOverlay('comments-form', '', 'Add note to anomaly #${anomalyID}:')"><img class="add-note-icon" src="images/edit_icon.png"></a></h1>`
            document.getElementById("anomaly-title").innerHTML = `Anomaly #${anomalyID} (${getStatusString(response.data.status)}) <a href="javascript:toggleOverlay('anomaly-form')"><img class="add-note-icon" src="images/edit_icon.png"></a>`

            axios.get(`/api/comments?anomaly-id=${anomalyID}`)
            .then(function (response) {

                let commentsData = response.data
                commentsTable = document.getElementById("anomaly-comment-table")
                commentsTable.innerHTML = ""

                for (let i = 0; i < commentsData.length; i++ ) {
                    axios.get(`/api/users/${commentsData[i].user_id}`)
                    .then(function (response) {
                        commentAuthor = response.data.name
                        commentTime = formatCommentDateString(commentsData[i].created_at)
                        commentText = `<tr class="comment-table-row">
                                        <td class="comment-table-body">
                                            <span class="comment-author">${commentAuthor}</span><i> ${formatCommentDateString(commentsData[i].created_at)}</i><br>
                                            ${commentsData[i].body}
                                        </td></tr>`
                        commentsTable.innerHTML += commentText
                    })   
                }  
            })
        })
    }
    axios.get(`/api/sensors/${sensorID}`)
        .then(function (response) {
            let sensorDetails = response.data

            axios.get(`/api/data?sensor=${sensorID}`)
            .then(function (response) {

                let sensorData = response.data
                luArr = formatDateString(sensorData.splice(-1)[0].time)
                lastUpdated = luArr[0] + ', ' + luArr[1]

                axios.get(`api/anomalies`)
                .then(function (response) {

                    anomaliesData = response.data
                    mostRecent = "No anomalies detected."

                    if (urlParams.has('anomalyID')) {
                        for (let i = 0; i < anomaliesData.length; i++) {
                            if (anomaliesData[i].id == urlParams.get('anomalyID')) {
                                mainAnomalyTime = anomaliesData[i].time
                            }
                        }
                        reportStartTime = new Date(mainAnomalyTime)
                        reportEndTime = new Date(mainAnomalyTime)
                        reportStartTime.setHours(reportStartTime.getHours() - 2)
                        reportEndTime.setHours(reportEndTime.getHours() + 2)
                    } else {
                        today = new Date()
                        reportStartTime = today
                        reportEndTime = new Date(today.setDate(today.getDate() - 7));
                    }

                    anomalyTimes = []
                    anomalySensors = []
                    anomalyIDs = []

                    let colourScale = chroma.scale(['#00FF00', '#FFFF00', '#FF0000']);
                    colours = []

                    for (let i = 0; i < anomaliesData.length; i++) {
                        anomalyTime = new Date(anomaliesData[i].time)
                        if (anomalyTime > reportStartTime && anomalyTime < reportEndTime) {
                            if (anomaliesData[i].sensor_id == sensorID) {
                                anomArr = formatDateString(anomaliesData[i].time)
                                mostRecent = anomArr[0] + ', ' + anomArr[1]
                                anomalyTimes.push(new Date(anomaliesData[i].time))
                                anomalySensors.push(anomaliesData[i].sensor_id)
                                anomalyIDs.push(anomaliesData[i].id)
                                if (urlParams.has('anomalyID') && anomaliesData[i].id == urlParams.get('anomalyID')) {
                                    colours.push('#1f4587')
                                } else {
                                    colour = colourScale(anomaliesData[i].confidence).hex()
                                    colours.push(colour)
                                }
                            } 
                        }
                    }
                    if (urlParams.has('anomalyID')) {
                        useDiv = 'anomaly-timeline-div-small'
                        document.getElementById('timeline-title').style.display = "block"
                        document.getElementById('anomaly-timeline-parent').style.display = "none"
                    } else {
                        useDiv = 'anomaly-timeline-div-main'
                    }
                    createAnomalyTimeline(useDiv, anomalyTimes, anomalySensors, anomalyIDs, [reportStartTime, reportEndTime], colours)
                    
                    document.getElementById('sensor-title').innerHTML = `Inspecting: ${sensorDetails.type} #${sensorID}`
                    let details = document.createElement("p")
                    sensorUnit = sensorDetails.unit
                    details.innerHTML = `
                    Sensor ID: <i>#${sensorDetails.id}</i><br>
                    Sensor Type: <i>${sensorDetails.type}</i><br>
                    Unit: <i>${formatUnitString(sensorDetails.unit)}</i><br>
                    Location: <i>${sensorDetails.location}</i><br><br>
                    Last Updated: <i>${lastUpdated}</i><br>
                    Last Detected Anomaly: <i>${mostRecent}</i>
                    `
                    document.getElementById("sensor-info").appendChild(details)
        
                    seriesData = createSeriesFromData(sensorData)
                    console.log(seriesData.vals)
                    generateLineGraph('week-chart', 'Data - Previous Week', [seriesData[weekVals], seriesData[weekMaxVals], seriesData[weekMinVals]], ['Values', 'Maximum Value', 'Minimum Value'], seriesData[weekLabels], sensorUnit, ['#1f4587', '#7e7e7e', '#7e7e7e'], true)
                    generateLineGraph('day-chart', 'Data - Previous 24 hours', [seriesData[dayVals]], ['Values'], seriesData[dayLabels], sensorUnit, ['#1f4587', '#1f4587'], false)
                })
            })

            axios.get(`/api/sensors`)
            .then(function (response) {
                connectedSensors = []
                connectedSensorTypes = []
                let allSensors = response.data

                for (let i = 0; i < allSensors.length; i++) {
                    if (allSensors[i].id != sensorID && allSensors[i].location == sensorDetails.location) {
                        connectedSensors.push(allSensors[i].id)
                        connectedSensorTypes.push(allSensors[i].subtype)
                    }
                }
                document.getElementById("location-graph-title").innerHTML += ' - ('+sensorDetails.location+')'
                mapConnectedSensors('location-graph', sensorID, connectedSensors, connectedSensorTypes)
            })
        })

    currentDataOffset = 0
    numRows = 30
    
    updateSensorData(sensorID, numRows, currentDataOffset*numRows)
    
    function incrementData() {
        currentDataOffset += 1
        updateSensorData(sensorID, numRows, currentDataOffset*numRows)
        document.getElementById('previous-data-btn').disabled = false
    }
    function decrementData() {
        if (currentDataOffset > 0) {
            currentDataOffset -= 1
            updateSensorData(sensorID, numRows, currentDataOffset*numRows)
            document.getElementById('next-data-btn').disabled = false
            if (currentDataOffset == 0) {
                document.getElementById('previous-data-btn').disabled = true
            }
        }
    }
    function reloadData() {
        currentDataOffset = 0
        updateSensorData(sensorID, numRows, currentDataOffset*numRows)
    }
</script>