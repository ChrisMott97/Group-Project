<html>
    <head>
        <title>SHM Monitoring Dashboard</title>
        <link href="css/stylesheet.css" rel='stylesheet' type='text/css'/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="js/js.js" charset="UTF-8"></script>
        <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    </head>
    <body>
        <div class="navbar-div">
            <a href="javascript:toggleOverlay('user-info')" class="profile-link"><p class="profile-name" id="profile-name"></p><img src="images/user_pic.png" class="profile-pic"></a>
        </div>
        <div class="sidebar-div">
            <div class="sidebar-icon-div">
                <a href="/dash"><span class="sidebar-icon-span">
                    <img src="images/dashboard_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div">
                <a href="/notifications"><span class="sidebar-icon-span">
                    <img src="images/notifications_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div">
                <a href="/images"><span class="sidebar-icon-span">
                    <img src="images/images_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div">
                <a href="/visualisations"><span class="sidebar-icon-span">
                    <img src="images/visualisations_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div sidebar-icon-active">
                <a href="/database"><span class="sidebar-icon-span">
                    <img src="images/database_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div">
                <a href="/code"><span class="sidebar-icon-span">
                    <img src="images/code_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
        </div>
        <div class="main-content-div">
            <h1 class="sensor-title" id="sensor-title"></h1>
            <div class="dashboard-tile-parent">
                <div class="dashboard-tile-div" id="sensor-info">
                    <h1 class="dashboard-title">Sensor Details</h1>
                </div>
                <div class="dashboard-tile-div" id="sensor-location">
                    <h1 class="dashboard-title" id="location-graph-title">Related Sensors</h1>
                    <div id="location-graph"></div>
                </div>
            </div>
            <div class="database-main-content-div" id="anomaly-info-div">
                <h1 class="dashboard-title" id="anomaly-title">Anomaly</h1>
                <p id="anomaly-info-text"></p>
                <div class="comment-table-div">
                    <table>
                        <tbody id="anomaly-comment-table">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="dashboard-tile-parent">
                <div class="dashboard-tile-div" id="week-chart-div">
                    <!--<h1 class="dashboard-title">Data - Previous Week</h1>-->
                    <div><canvas id="week-chart"></canvas></div>
                </div>
                <div class="dashboard-tile-div" id="day-chart-div">
                    <!--<h1 class="dashboard-title">Data - Previous 24 Hours</h1>-->
                    <div><canvas id="day-chart"></canvas></div>
                </div>
            </div>
            <div class="database-main-content-div" id="sensor-comments-div">
                <h1 class="dashboard-title" id="comment-title">Notes</h1>
                <div class="comment-table-div">
                    <table>
                        <tbody id="comment-table">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="database-main-content-div">
                <h1 class="dashboard-title">Sensor Values</h1>
                <form action="/sensor" method="GET" id="database-search-form">
                    <input type="date" id="date-from" name="from">
                    <input type="date" id="date-until" name="until">
                    <select name="ordering"><option value="newest">Newest First</option><option value="oldest">Oldest First</option></select><br>
                    <input class="button-styling" type="reset">
                    <input class="button-styling" type="submit" value="Search">
                </form>
                <table class="database-table">
                    <tbody id="sensor-data">
                        <tr class="database-table-row"><th>Date</th><th>Time</th><th>value</th></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="mobile-nav-div">
            <table class="mobile-nav-table">
                <tbody>
                    <tr class="mobile-nav-table-row">
                        <td class="mobile-nav-table-td"><a href="/dash"><img src="images/dashboard_icon_white.png" class="mobile-nav-icon-img"></a></td>
                        <td class="mobile-nav-table-td"><a href="/notifications"><img src="images/notifications_icon_white.png" class="mobile-nav-icon-img"></a></td>
                        <td class="mobile-nav-table-td"><a href="/images"><img src="images/images_icon_white.png" class="mobile-nav-icon-img"></a></td>
                        <td class="mobile-nav-table-td"><a href="/visualisations"><img src="images/visualisations_icon_white.png" class="mobile-nav-icon-img"></a></td>
                        <td class="mobile-nav-table-td"><a href="/database"><img src="images/database_icon_white.png" class="mobile-nav-icon-img"></a></td>
                        <td class="mobile-nav-table-td"><a href="/code"><img src="images/code_icon_white.png" class="mobile-nav-icon-img"></a></td>
                        <td class="mobile-nav-table-td"><a href="javascript:toggleOverlay('user-info')"><img src="images/user_pic_white.png" class="mobile-nav-icon-img"></a></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="overlay-shadow">
            <a href="javascript:toggleOverlay()"><span id="overlay-span"></span></a>
            <div id="overlay-div">
                <a href="javascript:toggleOverlay()"><img id="overlay-close" src="images/close.png"></a>
                <div id="overlay-content"></div>
            </div>
        </div>
        
    </body>
</html>
<script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    let sensorID = urlParams.get('sensorID')
                 
    axios.get(`/api/comments?sensor-id=${sensorID}`)
    .then(function (response) {
        let commentsData = response.data

        document.getElementById('comment-title').innerHTML += ` <a href="javascript:toggleOverlay('comments-form', '', 'Add note to sensor #${sensorID}:')"><img class="add-note-icon" src="images/edit_icon.png"></a>`
        commentsTable = document.getElementById("comment-table")
        commentsTable.innerHTML = ""

        for (let i = 0; i < commentsData.length; i++ ) {
            axios.get(`/api/users/${commentsData[i].user_id}`)
            .then(function (response) {
                commentAuthor = response.data.name
                commentText = `<tr class="comment-table-row">
                                <td class="comment-table-body">
                                    <span class="comment-author">${commentAuthor}</span><i> ${formatCommentDateString(commentsData[i].created_at)}</i><br>
                                    ${commentsData[i].body}
                                </td></tr>`
                commentsTable.innerHTML += commentText
            })   
        }
    })

    if (urlParams.has('anomalyID')) {
        const anomalyID = urlParams.get('anomalyID')

        axios.get(`/api/anomalies/${anomalyID}`)
        .then(function (response) {
            detectedAt = formatDateString(response.data.time)
            updatedAt = formatDateString(response.data.updated_at)
            if (response.data.confidence > 0.8) {trafficLight = 'red'}
            else if (response.data.confidence > 0.6) {trafficLight = 'orange'}
            else {trafficLight = 'green'}

            anomalyInfoDiv = document.getElementById("anomaly-info-div")
            anomalyInfoDiv.style.display = "block"
            anomalyText = `An anomaly was detected by this sensor at ${detectedAt[0]}, ${detectedAt[1]} with a
                            confidence of <i style="color: ${trafficLight};">${(response.data.confidence * 100).toFixed(1)}%</i>.`

            if (response.data.status != 1) {
                anomalyText += ` The status of this anomaly was marked
                            as <i>${response.data.status}</i> by <i>${response.data.name}</i> at ${updatedAt[0]}, ${updatedAt[1]}.`
            } else {
                anomalyText += ` This anomaly has not yet been investigated. Once the anomaly is under investigation, change the status using the edit icon above.`
            }

            document.getElementById("anomaly-info-text").innerHTML += anomalyText+ `<h1 class="dashboard-title" id="anomaly-comments-title">Notes <a href="javascript:toggleOverlay('comments-form', '', 'Add note to anomaly #${anomalyID}:')"><img class="add-note-icon" src="images/edit_icon.png"></a></h1>`
            document.getElementById("anomaly-title").innerHTML = `Anomaly #${anomalyID} (Under Investigation) <a href="javascript:toggleOverlay('anomaly-form')"><img class="add-note-icon" src="images/edit_icon.png"></a>`

            axios.get(`/api/comments?anomaly-id=${anomalyID}`)
            .then(function (response) {

                let commentsData = response.data
                commentsTable = document.getElementById("anomaly-comment-table")
                commentsTable.innerHTML = ""

                for (let i = 0; i < commentsData.length; i++ ) {
                    axios.get(`/api/users/${commentsData[i].user_id}`)
                    .then(function (response) {
                        commentAuthor = response.data.name
                        commentTime = formatCommentDateString(commentsData[i].created_at)
                        commentText = `<tr class="comment-table-row">
                                        <td class="comment-table-body">
                                            <span class="comment-author">${commentAuthor}</span><i> ${formatCommentDateString(commentsData[i].created_at)}</i><br>
                                            ${commentsData[i].body}
                                        </td></tr>`
                        commentsTable.innerHTML += commentText
                    })   
                }  
            })
        })
    }

    document.getElementById("database-search-form").innerHTML += `<input type="hidden" name="sensorID" value="${sensorID}">`
    
    let dataQuery = `/api/data?sensor=${sensorID}`
    
    if (urlParams.has('from')) {
        if (urlParams.get('from') != '') {
            document.getElementById('date-from').value = urlParams.get('from')
            dataQuery += `&from=${urlParams.get('from')}T00:00:00`
        }
    }
    if (urlParams.has('until')) {
        if (urlParams.get('until') != '') {
            document.getElementById('date-until').value = urlParams.get('until')
            dataQuery += `&until=${urlParams.get('until')}T23:59:59`
        }
    }

    axios.get(dataQuery)
    .then(function (response) {
        document.getElementById('sensor-data').innerHTML = `<tr class="database-table-row"><th>Date</th><th>Time</th><th>value</th></tr>`
        let sensorData = response.data
        lastUpdatedArray = formatDateString(sensorData[sensorData.length - 1].time)
        lastUpdated = lastUpdatedArray[0] + ', ' + lastUpdatedArray[1]

        axios.get(`/api/sensors/${sensorID}`)
        .then(function (response) {
            let sensorDetails = response.data

            document.getElementById('sensor-title').innerHTML = `Inspecting: ${sensorDetails.type} #${sensorID}`
            let details = document.createElement("p")
            sensorUnit = sensorDetails.unit
            details.innerHTML = `
            Sensor ID: <i>#${sensorDetails.id}</i><br>
            Sensor Type: <i>${sensorDetails.type}</i><br>
            Unit: <i>${formatUnitString(sensorDetails.unit)}</i><br>
            Location: <i>${sensorDetails.location}</i><br><br>
            Last Updated: <i>${lastUpdated}</i><br>
            Last Detected Anomaly: <i>${null}</i>
            `
            document.getElementById("sensor-info").appendChild(details)

            axios.get(`/api/data?sensor=${sensorID}`)
            .then(function (response) {
                let sensorData = response.data
                
                // Current day of iteration
                currentDay = formatDateString(sensorData[0].time)[0]
                // Current time used to get data for the preceding 24 hours
                currentTime = new Date(sensorData[sensorData.length - 1].time)
                
                dayTotal = 0
                numVals = 0
                labels = [currentDay]
                dayLabels = []
                dayVals = []
                vals = []
                maxVals = [Number.NEGATIVE_INFINITY]
                minVals = [Number.POSITIVE_INFINITY]
                
                for (let i = 0; i < sensorData.length; i++) {

                    if (sensorData[i].value < 1000) {

                        if (formatDateString(sensorData[i].time)[0] == currentDay) {
                            
                            dayTotal += sensorData[i].value
                            numVals += 1

                        } else {
                            maxVals.push(Number.NEGATIVE_INFINITY)
                            minVals.push(Number.POSITIVE_INFINITY)
                            vals.push(dayTotal / numVals)
                            dayTotal = sensorData[i].value
                            numVals = 1
                            currentDay = formatDateString(sensorData[i].time)[0]
                            labels.push(currentDay)
                        }

                        valueTime = new Date(sensorData[i].time)
                        if (currentTime - valueTime < (1000 * 60 * 60 * 24)) {
                            dayLabels.push(formatDateString(sensorData[i].time)[1].slice(0, -3))
                            dayVals.push(sensorData[i].value)
                        }
                        if (sensorData[i].value > maxVals[maxVals.length - 1]) {maxVals[maxVals.length - 1] = sensorData[i].value}
                        else if (sensorData[i].value < minVals[minVals.length - 1]) {minVals[minVals.length - 1] = sensorData[i].value}
                    }
                }
                vals.push(dayTotal / numVals)
                generateLineGraph('week-chart', 'Data - Previous Week', [vals, maxVals, minVals], ['Values', 'Maximum Value', 'Minimum Value'], labels, sensorUnit, ['#1f4587', '#7e7e7e', '#7e7e7e'], true)
                generateLineGraph('day-chart', 'Data - Previous 24 hours', [dayVals], ['Values'], dayLabels, sensorUnit, ['#1f4587', '#1f4587'], false)
            })

            axios.get(`/api/sensors`)
            .then(function (response) {
                connectedSensors = []
                connectedSensorTypes = []
                let allSensors = response.data

                for (let i = 0; i < allSensors.length; i++) {
                    if (allSensors[i].id != sensorID && allSensors[i].location == sensorDetails.location) {
                        connectedSensors.push(allSensors[i].id)
                        connectedSensorTypes.push(allSensors[i].subtype)
                    }
                }
                document.getElementById("location-graph-title").innerHTML += ' - ('+sensorDetails.location+')'
                generateLocationGraph('location-graph', sensorID, connectedSensors, connectedSensorTypes)
            })
        })

        if (urlParams.get('ordering') == 'newest') {sensorData = sensorData.reverse()}

        for (let i = 0; i < sensorData.length; i++ ) {
            table = document.getElementById("sensor-data")
            datetime = formatDateString(sensorData[i].time)
            if (sensorData[i].value < 1000) {table.innerHTML += `<tr class="database-table-row"><td>${datetime[0]}</td><td>${datetime[1]}</td><td>${sensorData[i].value.toFixed(8)}</td></tr>` }
        }
    })
</script>