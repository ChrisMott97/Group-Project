<html>
    <head>
        <title>SHM Monitoring Dashboard</title>
        <link href="css/stylesheet.css" rel='stylesheet' type='text/css'/>
        <script src="js/js.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
        <script>
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            let sensorID = urlParams.get('sensorID')

            axios.get(`http://localhost:3030/sensors/${sensorID}`)
            .then(function (response) {
                let sensorDetails = response.data

                document.getElementById('sensor-title').innerHTML = `Inspecting: ${sensorDetails.type} #${sensorID}`
                let details = document.createElement("p")
                details.innerHTML = `
                Sensor ID: <i>#${sensorDetails.id}</i><br>
                Sensor Type: <i>${sensorDetails.type}</i><br>
                Unit: <i>${sensorDetails.unit}</i><br>
                Location: <i>${sensorDetails.location}</i><br><br>
                Last Updated: <i>${null}</i><br>
                Last Detected Anomaly: <i>${null}</i>
                `
                document.getElementById("sensor-info").appendChild(details)
            })

        </script>
    </head>
    <body>
        <div class="navbar-div">
            <a href="javascript:toggleOverlay('user-info')" class="profile-link"><p class="profile-name" id="profile-name"></p><img src="images/user-pic.png" class="profile-pic"></a>
        </div>
        <div class="sidebar-div">
            <div class="sidebar-icon-div">
                <a href="dash.html"><span class="sidebar-icon-span">
                    <img src="images/dashboard_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div">
                <a href="notifications.html"><span class="sidebar-icon-span">
                    <img src="images/notifications_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div">
                <a href="images.html"><span class="sidebar-icon-span">
                    <img src="images/images_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div">
                <a href="visualisations.html"><span class="sidebar-icon-span">
                    <img src="images/visualisations_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div sidebar-icon-active">
                <a href="database.html"><span class="sidebar-icon-span">
                    <img src="images/database_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
            <div class="sidebar-icon-div">
                <a href="code.html"><span class="sidebar-icon-span">
                    <img src="images/code_icon.png" class="sidebar-icon-img">
                </span></a>
            </div>
        </div>
        <div class="main-content-div">
            <h1 class="sensor-title" id="sensor-title"></h1>
            <div class="dashboard-tile-parent">
                <div class="dashboard-tile-div" id="sensor-info">
                    <h1 class="dashboard-title">Sensor Details</h1>
                </div>
                <div class="dashboard-tile-div" id="sensor-location">
                    <h1 class="dashboard-title">Sensor Location</h1>
                    <img src="images/humber_diagram.png" id="humber-diagram">
                </div>
            </div>
            <div class="database-main-content-div" id="anomaly-info"></div>
            <div class="dashboard-tile-parent">
                <div class="dashboard-tile-div" id="graph1-div">
                    <h1 class="dashboard-title">Sensor Data</h1>
                    <canvas id="graph1-chart"></canvas></div>
                <div class="dashboard-tile-div" id="graph2-div">
                    <h1 class="dashboard-title">Sensor Data</h1>
                    <canvas id="graph2-chart"></canvas></div>
            </div>
            <div class="database-main-content-div">
                <h1 class="dashboard-title">Sensor Database</h1>
                <form action="sensor.html" method="GET" id="database-search-form">
                    <table class="database-search-table">
                        <tbody>
                            <tr>
                                
                                <td class="database-search-table-td"><input type="date" id="date-from" name="from"></td>
                                <td class="database-search-table-td"><input type="date" id="date-until" name="until"></td>
                                <td class="database-search-table-td"><select name="ordering"><option value="newest">Newest First</option><option value="oldest">Oldest First</option></select></td>
                                <td class="database-search-table-td"><input type="reset"></td>
                                <td class="database-search-table-td"><input type="submit"></td>
                            </tr>
                        </tbody>
                    </table>
                </form>
                <table class="database-table">
                    <tbody id="sensor-data">
                        <tr class="database-table-row"><th>Date</th><th>Time</th><th>value</th></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="overlay-shadow">
            <a href="javascript:toggleOverlay()"><span id="overlay-span"></span></a>
            <div id="overlay-div">
                <a href="javascript:toggleOverlay()"><img id="overlay-close" src="images/close.png"></a>
                <div id="overlay-content"></div>
            </div>
        </div>
    </body>
</html>
<script>
    if (urlParams.has('anomalyID')) {
        const anomalyID = urlParams.get('anomalyID')

        
        axios.get(`http://localhost:3030/anomalies/${anomalyID}`)
        .then(function (response) {
            detectedAt = formatDateString(response.data.time)
            updatedAt = formatDateString(response.data.updated_at)
            if (response.data.confidence > 0.8) {trafficLight = 'red'}
            else if (response.data.confidence > 0.6) {trafficLight = 'orange'}
            else {trafficLight = 'green'}

            anomalyInfo = document.getElementById("anomaly-info")
            anomalyInfo.style.display = "block"
            anomalyText = `An anomaly was detected by this sensor at ${detectedAt[0]}, ${detectedAt[1]} with a
                           confidence of <i style="color: ${trafficLight};">${response.data.confidence * 100}%</i>. The status of this anomaly was marked
                           as <i>${response.data.status}</i> by <i>${response.data.name}</i> at ${updatedAt[0]}, ${updatedAt[1]}.
                           <br><br>Notes:
                           <br>${response.data.notes}`
            anomalyInfo.innerHTML += anomalyText
        })
    }

    document.getElementById("database-search-form").innerHTML += `<input type="hidden" name="sensorID" value="${sensorID}">`
    
    let dataQuery = `http://localhost:3030/data?sensor=${sensorID}`
    
    if (urlParams.has('from')) {
        if (urlParams.get('from') != '') {
            document.getElementById('date-from').value = urlParams.get('from')
            dataQuery += `&from=${urlParams.get('from')}T00:00:00`
        }
    }
    if (urlParams.has('until')) {
        if (urlParams.get('until') != '') {
            document.getElementById('date-until').value = urlParams.get('until')
            dataQuery += `&until=${urlParams.get('until')}T23:59:59`
        }
    }

    axios.get(dataQuery)
    .then(function (response) {
        document.getElementById('sensor-data').innerHTML = `<tr class="database-table-row"><th>Date</th><th>Time</th><th>value</th></tr>`
        let sensorData = response.data

        console.log(dataQuery)

        if (urlParams.get('ordering') == 'newest') {sensorData = sensorData.reverse()}

        for (let i = 0; i < sensorData.length; i++ ) {
            table = document.getElementById("sensor-data")
            datetime = formatDateString(sensorData[i].time)
            table.innerHTML += `<tr class="database-table-row"><td>${datetime[0]}</td><td>${datetime[1]}</td><td>${sensorData[i].value}</td></tr>`
        }
    })

    axios.get(`http://localhost:3030/data?sensor=${sensorID}`)
    .then(function (response) {
        let sensorData = response.data
        generateLineGraph('graph1-chart', sensorData.slice(0, Math.round(sensorData.length/2)))
        generateLineGraph('graph2-chart', sensorData.slice(Math.round((sensorData.length/2)), sensorData.length))
    })
    
</script>